<?php

namespace App\Livewire\Reservasi;

use App\Models\Kamar;
use App\Models\Pesanan;
use App\Models\Tamu;
use Livewire\Component;
use App\Models\Reservasi;


class ReservasiCreate extends Component
{
    

    public $alamat;
    public $kota;
    public $email;
    public $no_identitas;
    public $jumlah_anak;
    public $jumlah_dewasa;
    
    
    
    public $tanggal_check_in;
    public $tanggal_check_out;
    public $id_jenis_kamar;
    public $jumlahKamar = 1;
    public $jumlahTersedia;
    public $idTamu = null;
    public $nama;
    public $no_tlpn;


    public $id_diskon;
    public $persentase_diskon;



    public $id_harga;
    public $persentase_kenaikan_harga;

    
    public $jumlahHari;
    public $hargaDasar;
    public $totalHarga;
    public $reset = false;



    private function buatNoReservasi()
    {
        do {
            $lastReservasi = Reservasi::latest('id')->first();
            $nextNumber = $lastReservasi ? ((int)substr($lastReservasi->no_reservasi, 4)) + 1 : 1;
            $no_reservasi = 'RESV' . str_pad($nextNumber, 3, '0', STR_PAD_LEFT);
        } while (Reservasi::where('no_reservasi', $no_reservasi)->exists());

        return $no_reservasi;
    }



    public function resetForm() {
        $this->alamat = null;
        $this->kota = null;
        $this->email = null;
        $this->no_identitas = null;
        $this->jumlah_anak = null;
        $this->jumlah_dewasa = null;
        
        $this->tanggal_check_in = null;
        $this->tanggal_check_out = null;
        $this->id_jenis_kamar = null;
        $this->jumlahKamar = 1;
        $this->jumlahTersedia = null;
        $this->idTamu = null;
        $this->nama = null;
        $this->no_tlpn = null;
    
        $this->id_diskon = null;
        $this->persentase_diskon = null;
    
        $this->id_harga = null;
        $this->persentase_kenaikan_harga = null;
    
        $this->jumlahHari = null;
        $this->hargaDasar = 0;
        $this->totalHarga = null;
    
        $this->reset = true; // Menandakan bahwa reset telah dilakukan
    }
    




    public function save()
    {
        $this->hargaDasar = number_format($this->hargaDasar, 2, '.', '');
        $this->totalHarga = number_format($this->totalHarga, 2, '.', '');
        // Menampilkan semua properti untuk debug
        // dd([
        //     'alamat' => $this->alamat,
        //     'kota' => $this->kota,
        //     'email' => $this->email,
        //     'no_identitas' => $this->no_identitas,
        //     'jumlah_anak' => $this->jumlah_anak,
        //     'jumlah_dewasa' => $this->jumlah_dewasa,
        //     'tanggal_check_in' => $this->tanggal_check_in,
        //     'tanggal_check_out' => $this->tanggal_check_out,
        //     'id_jenis_kamar' => $this->id_jenis_kamar,
        //     'jumlahKamar' => $this->jumlahKamar,
        //     'jumlahTersedia' => $this->jumlahTersedia,
        //     'idTamu' => $this->idTamu,
        //     'nama' => $this->nama,
        //     'no_tlpn' => $this->no_tlpn,
        //     'jumlahHari' => $this->jumlahHari,
        //     'hargaDasar' => $this->hargaDasar,
        //     'totalHarga' => $this->totalHarga,
        //     'reset' => $this->reset,
        //     'id_diskon' => $this->id_diskon,
        //     'persentase_diskon' => $this->persentase_diskon,
        //     'id_harga' => $this->id_harga,
        //     'persentase_kenaikan_harga' => $this->persentase_kenaikan_harga,
        // ]);

        // dd(is_null($this->idTamu));

   
        if (is_null($this->idTamu)) {
            $tamu = Tamu::create([
                'nama' => $this->nama,
                'no_tlpn' => $this->no_tlpn,
                'alamat' => 'no-data',
                'email' => 'no-data', 
                'kota' => 'no-data',
                'no_identitas' => 'no-data',
            ]);
        }

        $kamar = Kamar::where('id_jenis_kamar', $this->id_jenis_kamar)->first();


        $reservasi = Reservasi::create([
            'no_reservasi' => $this->buatNoReservasi(),
            'id_tamu' => $tamu->id ?? $this->idTamu,
            'tanggal_check_in' => $this->tanggal_check_in,
            'tanggal_check_out' => $this->tanggal_check_out,
            'jumlah_kamar' => $this->jumlahKamar,
            'total_harga' => $this->totalHarga,
            'status_reservasi' => 'dipesan',
        ]);

        Pesanan::create([
            'id_reservasi' => $reservasi->id,
            'id_kamar' => $kamar->id, 
            'id_diskon' => $this->id_diskon ?? null,
            'id_harga' => $this->id_harga ?? null,
            'harga_kamar' => $kamar->harga_kamar,
            'harga_akhir' => $this->hargaDasar,
            'jumlah_malam' => $this->jumlahHari,
            'subtotal' => $this->totalHarga
        ]);


        $reservasi->update([
        'total_harga' => Pesanan::where('id_reservasi', $reservasi->id)->sum('subtotal')
    ]);
        

        $simpan = $reservasi;

        // dd($simpan);
        is_null($simpan)
            ? $this->dispatch('notify', title: 'fail', message: 'Data gagal disimpan')
            : $this->dispatch('notify', title: 'success', message: 'Data berhasil disimpan');
    
        $this->dispatch('dispatch-reservasi-create-save');
        $this->resetForm();
    }
    
    public function render()
    {
        return view('livewire.reservasi.reservasi-create');
    }
}



















                                 
@if ($pembayaran)
<div class="bg-white p-4 rounded-xl border border-gray-100">
    <h4 class="text-sm font-semibold text-gray-500 mb-3">Detail Pembayaran</h4>
    <div class="space-y-3">
        <div class="flex justify-between">
            <span class="text-sm text-gray-600">Jumlah Pembayaran</span>
            <span class="text-sm font-medium text-green-600">
                {{-- Rp {{ number_format($jumlahPembayaran, 0, ',', '.') }} --}}
            </span>
        </div>
        
        <div class="flex justify-between">
            <span class="text-sm text-gray-600">Kembalian</span>
            <span class="text-sm font-medium text-gray-900">
                {{-- Rp {{ number_format($kembalian, 0, ',', '.') }} --}}
            </span>
        </div>
        
        @if($status_reservasi == 'check_out')
            <div class="flex justify-between">
                <span class="text-sm text-gray-600">Denda</span>
                <span class="text-sm font-medium text-red-600">
                    {{-- Rp {{ number_format($denda, 0, ',', '.') }} --}}
                </span>
            </div>
        @endif
        
        <div class="pt-2 border-t border-gray-100">
            <div class="flex justify-between items-center">
                <span class="text-xs text-gray-500">Transaksi. {{ $user ?? 'System' }}</span>
            </div>
        </div>
    </div>
</div>

@endif































<div class="bg-blue-50 p-4 rounded-xl border border-blue-100" 
     x-data="dendaComponent(
         {{ $res->total_harga ?? 0 }}, 
         {{ $res->pembayaran->jumlah_pembayaran ?? 0 }}
     )">
    <div class="flex items-center gap-4">
        <!-- Input Denda -->
        <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-2">Denda</label>
            <input type="text" 
                   x-model.number="denda" 
                   @input="$wire.Idenda = $event.target.value"
                   class="input input-bordered w-full text-md btn-md" 
                   placeholder="(Opsional) Masukkan jumlah denda">
        </div>

        <!-- Input Keterangan -->
        <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
            <textarea class="textarea textarea-bordered w-full text-md btn-md" 
                      wire:model="Iketerangan" 
                      placeholder="Masukkan keterangan"></textarea>
        </div>

        <!-- Input Bayar Kedua -->
        <div class="flex-1" x-show="showBayarKedua">
            <label class="block text-sm font-medium text-gray-700 mb-2">Bayar Kedua</label>
            <input type="text" 
                   x-model.number="bayarKedua" 
                   @input="$wire.bayarKedua = $event.target.value"
                   class="input input-bordered w-full text-md btn-md" 
                   placeholder="Masukkan pembayaran kedua">
        </div>

        <!-- Info Kembalian -->
        <div x-show="kembalian >= 0" class="flex-1">
            <p class="text-sm font-medium text-gray-700">
                Kembalian: <span x-text="formatRupiah(kembalian)"></span>
            </p>
        </div>

        <!-- Tombol Checkout -->
        <div>
            <button type="submit" 
                    :disabled="!isCheckoutAllowed" 
                    class="w-full mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-200 disabled:opacity-50">
                Checkout
            </button>
        </div>
    </div>
</div>

<script>
    function dendaComponent(initialTotal, initialPembayaran) {
        return {
            denda: 0,
            bayarKedua: 0,
            totalHarga: initialTotal,
            pembayaranAwal: initialPembayaran,
            
            get showBayarKedua() {
                return this.totalHarga > this.pembayaranAwal;
            },
            
            get totalPembayaran() {
                return this.pembayaranAwal + this.bayarKedua;
            },
            
            get kembalian() {
                return this.totalPembayaran - this.totalHarga;
            },
            
            get isCheckoutAllowed() {
                return this.kembalian >= 0 && 
                      (!this.showBayarKedua || (this.showBayarKedua && this.bayarKedua > 0));
            },
            
            formatRupiah(angka) {
                return new Intl.NumberFormat("id-ID", {
                    style: "currency",
                    currency: "IDR",
                    minimumFractionDigits: 0
                }).format(angka || 0);
            },
            
            init() {
                this.$watch('denda', (value) => {
                    this.totalHarga = initialTotal + (parseFloat(value) || 0);
                });
            }
        }
    }
</script>